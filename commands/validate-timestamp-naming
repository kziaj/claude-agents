#!/bin/bash

# Claude Command: Validate Timestamp Naming Convention
# Usage: validate-timestamp-naming [--directory verified|scratch|path] [--fix]
# Description: Validates that timestamp columns in base models follow _at suffix convention

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Default directory
DIRECTORY="models/models_verified/base"
FIX_MODE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --directory)
            DIRECTORY="$2"
            shift 2
            ;;
        --fix)
            FIX_MODE=true
            shift
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Usage: validate-timestamp-naming [--directory verified|scratch|path] [--fix]"
            exit 1
            ;;
    esac
done

# Resolve directory shortcuts
case $DIRECTORY in
    verified)
        DIRECTORY="models/models_verified/base"
        ;;
    scratch)
        DIRECTORY="models/models_scratch/base"
        ;;
esac

# Check if directory exists
if [ ! -d "$DIRECTORY" ]; then
    echo -e "${RED}Error: Directory not found: $DIRECTORY${NC}"
    exit 1
fi

echo -e "${PURPLE}═══════════════════════════════════════════════${NC}"
echo -e "${PURPLE}   Timestamp Naming Convention Validator${NC}"
echo -e "${PURPLE}═══════════════════════════════════════════════${NC}"
echo -e "${BLUE}Scanning directory:${NC} $DIRECTORY"
echo

# Patterns to check (without _at suffix)
TIMESTAMP_PATTERNS=(
    "created[,:]"
    "modified[,:]"
    "updated[,:]"
    "deleted[,:]"
    "loaded[,:]"
    "synced[,:]"
)

VIOLATIONS_FOUND=0
VIOLATIONS_FILE="/tmp/timestamp-violations-$$.txt"
> "$VIOLATIONS_FILE"

# Scan for violations
for pattern in "${TIMESTAMP_PATTERNS[@]}"; do
    # Extract the base word (remove regex pattern)
    base_word=$(echo "$pattern" | sed 's/\[.*\]//')
    
    # Search for the pattern (e.g., "as created," or "as modified,")
    # But exclude patterns that already have _at
    results=$(rg "(?i)\s+as\s+${base_word}[,\s]" "$DIRECTORY" --type sql -n 2>/dev/null | grep -v "${base_word}_at" || true)
    
    if [ -n "$results" ]; then
        echo -e "${YELLOW}Found violations for: ${base_word}${NC}"
        echo "$results"
        echo "$results" >> "$VIOLATIONS_FILE"
        VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
        echo
    fi
done

# Also check for timestamp casts without _at
echo -e "${BLUE}Checking timestamp casts...${NC}"
cast_violations=$(rg "::timestamp.*as\s+(created|modified|updated|deleted|loaded|synced)," "$DIRECTORY" --type sql -i -n 2>/dev/null | grep -v "_at," || true)

if [ -n "$cast_violations" ]; then
    echo -e "${YELLOW}Found timestamp cast violations:${NC}"
    echo "$cast_violations"
    echo "$cast_violations" >> "$VIOLATIONS_FILE"
    VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
    echo
fi

# Summary
echo -e "${PURPLE}═══════════════════════════════════════════════${NC}"
if [ $VIOLATIONS_FOUND -eq 0 ]; then
    echo -e "${GREEN}✓ No violations found!${NC}"
    echo -e "${GREEN}All timestamp columns follow _at suffix convention.${NC}"
    rm "$VIOLATIONS_FILE"
    exit 0
else
    echo -e "${RED}✗ Found $VIOLATIONS_FOUND violation type(s)${NC}"
    echo
    echo -e "${YELLOW}Common fixes needed:${NC}"
    echo "1. Update base model SQL: created → created_at"
    echo "2. Update downstream transform references"
    echo "3. Update YAML documentation"
    echo
    
    if [ "$FIX_MODE" = true ]; then
        echo -e "${BLUE}Fix mode not yet implemented.${NC}"
        echo -e "${BLUE}Please manually update the files listed above.${NC}"
    else
        echo -e "${BLUE}Run with --fix to auto-correct (not yet implemented)${NC}"
    fi
    
    echo
    echo -e "${BLUE}Violations saved to: $VIOLATIONS_FILE${NC}"
    exit 1
fi
