#!/bin/bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

print_header() {
    echo -e "${PURPLE}═══════════════════════════════════════════════${NC}"
    echo -e "${PURPLE}$1${NC}"
    echo -e "${PURPLE}═══════════════════════════════════════════════${NC}"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_pass() {
    echo -e "${GREEN}✅ PASS${NC} $1"
}

print_fail() {
    echo -e "${RED}❌ FAIL${NC} $1"
}

if [ -f "dbt_project.yml" ]; then
    DBT_PROJECT_DIR="$(pwd)"
elif [ -d "$HOME/ds-redshift" ] && [ -f "$HOME/ds-redshift/dbt_project.yml" ]; then
    DBT_PROJECT_DIR="$HOME/ds-redshift"
elif [ -d "$HOME/carta/ds-dbt" ] && [ -f "$HOME/carta/ds-dbt/dbt_project.yml" ]; then
    DBT_PROJECT_DIR="$HOME/carta/ds-dbt"
else
    print_fail "Could not find dbt project. Run from project directory or ensure ~/carta/ds-dbt exists"
    exit 1
fi

cd "$DBT_PROJECT_DIR"

if [ ! -f "scripts/verified_models_reference_check.py" ]; then
    print_fail "Could not find scripts/verified_models_reference_check.py in dbt project"
    exit 1
fi

print_header "Verified Models Reference Check"
echo ""

CHECK_MODE=""
FILES=""

if [ "$1" == "--all" ]; then
    CHECK_MODE="all"
    print_info "Checking ALL models in models_verified/ (this may take a while)"
elif [ "$#" -gt 0 ]; then
    CHECK_MODE="files"
    FILES="$@"
    print_info "Checking specified files: $FILES"
else
    CHECK_MODE="changed"
    print_info "Auto-detecting changed verified models in current branch"
    
    MAIN_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")
    
    if ! git rev-parse "$MAIN_BRANCH" &>/dev/null; then
        MAIN_BRANCH="main"
    fi
    
    CHANGED_FILES=$(git diff --name-only "$MAIN_BRANCH"...HEAD 2>/dev/null | grep "models_verified.*\.sql$" || true)
    
    if [ -z "$CHANGED_FILES" ]; then
        print_pass "No changed verified models found in current branch"
        echo ""
        echo "Usage:"
        echo "  check-verified-references                    # Check changed files (current)"
        echo "  check-verified-references <file1> <file2>    # Check specific files"
        echo "  check-verified-references --all              # Check all verified models"
        exit 0
    fi
    
    FILES="$CHANGED_FILES"
    echo ""
    echo "Found $(echo "$FILES" | wc -l | tr -d ' ') changed verified model(s):"
    echo "$FILES" | sed 's/^/  /'
fi

echo ""
print_info "Running verification check..."
echo ""

if [ -f ".env" ]; then
    source .env
fi

case "$CHECK_MODE" in
    "all")
        poetry run python scripts/verified_models_reference_check.py
        ;;
    "files"|"changed")
        poetry run python scripts/verified_models_reference_check.py --files $FILES
        ;;
esac

EXIT_CODE=$?

echo ""
if [ $EXIT_CODE -eq 0 ]; then
    print_pass "All verified models reference other verified models only"
    echo ""
    echo "✅ No scratch model references found."
else
    print_fail "Some verified models reference scratch models"
    echo ""
    echo "Common fixes:"
    echo "  • Ensure all dependencies are also in models_verified/"
    echo "  • Check ref() calls don't include _scratch suffix"
    echo "  • Migrate upstream models to verified first"
fi

exit $EXIT_CODE
