#!/bin/bash

# Claude Command: Compare Model Data (Scratch vs Verified)
# Usage: compare-model-data SCRATCH_TABLE VERIFIED_TABLE [--threshold PERCENT]
# Description: Validates data consistency between scratch and verified models

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Function to print colored output
print_header() {
    echo -e "${PURPLE}═══════════════════════════════════════════════${NC}"
    echo -e "${PURPLE}$1${NC}"
    echo -e "${PURPLE}═══════════════════════════════════════════════${NC}"
}

print_check() {
    echo -e "${BLUE}[CHECK]${NC} $1"
}

print_pass() {
    echo -e "${GREEN}✅ PASS${NC} $1"
}

print_fail() {
    echo -e "${RED}❌ FAIL${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠️  WARN${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Function to show usage
show_usage() {
    echo "Usage: compare-model-data SCRATCH_TABLE VERIFIED_TABLE [--threshold PERCENT]"
    echo ""
    echo "Compares data between scratch and verified model versions."
    echo ""
    echo "Arguments:"
    echo "  SCRATCH_TABLE   Full table path for scratch version (e.g., DBT_CORE.CORE_DIM_SUBSCRIPTIONS)"
    echo "  VERIFIED_TABLE  Full table path for verified version (e.g., DBT_VERIFIED_TRANSFORM.TRANSFORM_CORPORATIONS_SUBSCRIPTIONS)"
    echo "  --threshold     Acceptable difference percentage (default: 0.1%)"
    echo ""
    echo "Examples:"
    echo "  compare-model-data DBT_CORE.CORE_DIM_SUBSCRIPTIONS DBT_VERIFIED_TRANSFORM.TRANSFORM_CORPORATIONS_SUBSCRIPTIONS"
    echo "  compare-model-data DEV_KLAJDI_ZIAJ_DB.DBT_CORE.MODEL_A DEV_KLAJDI_ZIAJ_DB.DBT_VERIFIED_TRANSFORM.MODEL_B --threshold 0.5"
    echo ""
    echo "Exit codes:"
    echo "  0 - Data matches within threshold"
    echo "  1 - Data differences exceed threshold or errors occurred"
}

# Parse arguments
if [ $# -lt 2 ]; then
    print_fail "Missing required arguments"
    show_usage
    exit 1
fi

SCRATCH_TABLE="$1"
VERIFIED_TABLE="$2"
THRESHOLD=0.1  # Default 0.1% difference allowed

# Parse optional threshold
shift 2
while [[ $# -gt 0 ]]; do
    case $1 in
        --threshold)
            THRESHOLD="$2"
            shift 2
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        *)
            print_fail "Unknown argument: $1"
            show_usage
            exit 1
            ;;
    esac
done

# Results directory
RESULTS_DIR="$HOME/.claude/results/data-comparisons"
mkdir -p "$RESULTS_DIR"

# Extract model names from table paths
SCRATCH_MODEL=$(echo "$SCRATCH_TABLE" | awk -F'.' '{print $NF}')
VERIFIED_MODEL=$(echo "$VERIFIED_TABLE" | awk -F'.' '{print $NF}')
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="$RESULTS_DIR/${VERIFIED_MODEL}_comparison_${TIMESTAMP}.md"

print_header "Data Comparison: Scratch vs Verified"
echo ""
print_info "Scratch Table:  $SCRATCH_TABLE"
print_info "Verified Table: $VERIFIED_TABLE"
print_info "Threshold:      ${THRESHOLD}%"
echo ""

# Initialize report
cat > "$REPORT_FILE" << EOF
# Data Comparison Report
**Generated:** $(date)
**Command:** compare-model-data $SCRATCH_TABLE $VERIFIED_TABLE

## Configuration
- **Scratch Table:** \`$SCRATCH_TABLE\`
- **Verified Table:** \`$VERIFIED_TABLE\`
- **Difference Threshold:** ${THRESHOLD}%

EOF

FAILED_CHECKS=0
TOTAL_CHECKS=0

#############################################
# CHECK 1: Row Count Comparison
#############################################
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
print_check "Check 1: Comparing row counts..."

SCRATCH_COUNT=$(snow sql --query "SELECT COUNT(*) AS count FROM $SCRATCH_TABLE;" --format JSON 2>/dev/null | grep -o '"COUNT":[0-9]*' | grep -o '[0-9]*' || echo "0")
VERIFIED_COUNT=$(snow sql --query "SELECT COUNT(*) AS count FROM $VERIFIED_TABLE;" --format JSON 2>/dev/null | grep -o '"COUNT":[0-9]*' | grep -o '[0-9]*' || echo "0")

if [ "$SCRATCH_COUNT" = "0" ] && [ "$VERIFIED_COUNT" = "0" ]; then
    print_fail "Unable to query tables - verify table names and Snowflake connection"
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
    echo "## ❌ CHECK 1: Row Count Comparison - FAILED" >> "$REPORT_FILE"
    echo "Unable to query tables. Verify table names and Snowflake connection." >> "$REPORT_FILE"
else
    # Calculate difference percentage
    if [ "$SCRATCH_COUNT" -gt 0 ]; then
        DIFF=$((VERIFIED_COUNT - SCRATCH_COUNT))
        DIFF_PCT=$(echo "scale=2; ($DIFF * 100.0) / $SCRATCH_COUNT" | bc)
        ABS_DIFF_PCT=$(echo "$DIFF_PCT" | tr -d '-')
        
        print_info "Scratch rows:  $SCRATCH_COUNT"
        print_info "Verified rows: $VERIFIED_COUNT"
        print_info "Difference:    $DIFF rows (${DIFF_PCT}%)"
        
        # Compare against threshold
        THRESHOLD_CHECK=$(echo "$ABS_DIFF_PCT < $THRESHOLD" | bc -l)
        
        if [ "$THRESHOLD_CHECK" -eq 1 ]; then
            print_pass "Row counts match within ${THRESHOLD}% threshold"
            echo "## ✅ CHECK 1: Row Count Comparison - PASSED" >> "$REPORT_FILE"
        else
            print_fail "Row counts differ by ${DIFF_PCT}% (threshold: ${THRESHOLD}%)"
            FAILED_CHECKS=$((FAILED_CHECKS + 1))
            echo "## ❌ CHECK 1: Row Count Comparison - FAILED" >> "$REPORT_FILE"
        fi
        
        cat >> "$REPORT_FILE" << EOF

| Metric | Scratch | Verified | Difference |
|--------|---------|----------|------------|
| Row Count | $SCRATCH_COUNT | $VERIFIED_COUNT | $DIFF (${DIFF_PCT}%) |

EOF
    else
        print_warning "Scratch table is empty"
        echo "## ⚠️ CHECK 1: Row Count Comparison - SKIPPED (scratch table empty)" >> "$REPORT_FILE"
    fi
fi
echo ""

#############################################
# CHECK 2: Schema Comparison
#############################################
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
print_check "Check 2: Comparing table schemas..."

SCRATCH_COLS=$(snow sql --query "SELECT column_name, data_type FROM information_schema.columns WHERE table_name = '${SCRATCH_MODEL}' ORDER BY ordinal_position;" --format JSON 2>/dev/null || echo "[]")
VERIFIED_COLS=$(snow sql --query "SELECT column_name, data_type FROM information_schema.columns WHERE table_name = '${VERIFIED_MODEL}' ORDER BY ordinal_position;" --format JSON 2>/dev/null || echo "[]")

SCRATCH_COL_COUNT=$(echo "$SCRATCH_COLS" | grep -o '"COLUMN_NAME"' | wc -l | xargs)
VERIFIED_COL_COUNT=$(echo "$VERIFIED_COLS" | grep -o '"COLUMN_NAME"' | wc -l | xargs)

if [ "$SCRATCH_COL_COUNT" -eq 0 ] && [ "$VERIFIED_COL_COUNT" -eq 0 ]; then
    print_warning "Unable to retrieve schemas - skipping schema check"
    echo "## ⚠️ CHECK 2: Schema Comparison - SKIPPED (unable to retrieve schemas)" >> "$REPORT_FILE"
else
    print_info "Scratch columns:  $SCRATCH_COL_COUNT"
    print_info "Verified columns: $VERIFIED_COL_COUNT"
    
    if [ "$SCRATCH_COL_COUNT" -eq "$VERIFIED_COL_COUNT" ]; then
        print_pass "Column counts match"
        echo "## ✅ CHECK 2: Schema Comparison - PASSED" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        echo "Both tables have $SCRATCH_COL_COUNT columns." >> "$REPORT_FILE"
    else
        print_warning "Column counts differ ($SCRATCH_COL_COUNT vs $VERIFIED_COL_COUNT)"
        echo "## ⚠️ CHECK 2: Schema Comparison - WARNING" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        echo "**Scratch:** $SCRATCH_COL_COUNT columns  " >> "$REPORT_FILE"
        echo "**Verified:** $VERIFIED_COL_COUNT columns" >> "$REPORT_FILE"
    fi
fi
echo ""

#############################################
# CHECK 3: Sample Data Comparison
#############################################
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
print_check "Check 3: Comparing sample data (first 5 rows)..."

SCRATCH_SAMPLE=$(snow sql --query "SELECT * FROM $SCRATCH_TABLE LIMIT 5;" --format JSON 2>/dev/null || echo "[]")
VERIFIED_SAMPLE=$(snow sql --query "SELECT * FROM $VERIFIED_TABLE LIMIT 5;" --format JSON 2>/dev/null || echo "[]")

if [ "$SCRATCH_SAMPLE" = "[]" ] || [ "$VERIFIED_SAMPLE" = "[]" ]; then
    print_warning "Unable to retrieve sample data - skipping sample comparison"
    echo "## ⚠️ CHECK 3: Sample Data Comparison - SKIPPED" >> "$REPORT_FILE"
else
    print_pass "Sample data retrieved (manual review recommended)"
    echo "## ℹ️ CHECK 3: Sample Data Comparison - INFO" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "Sample data retrieved. Manual review recommended for semantic validation." >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "<details>" >> "$REPORT_FILE"
    echo "<summary>View Sample Data</summary>" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "### Scratch Sample (first 5 rows)" >> "$REPORT_FILE"
    echo "\`\`\`json" >> "$REPORT_FILE"
    echo "$SCRATCH_SAMPLE" | head -20 >> "$REPORT_FILE"
    echo "\`\`\`" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "### Verified Sample (first 5 rows)" >> "$REPORT_FILE"
    echo "\`\`\`json" >> "$REPORT_FILE"
    echo "$VERIFIED_SAMPLE" | head -20 >> "$REPORT_FILE"
    echo "\`\`\`" >> "$REPORT_FILE"
    echo "</details>" >> "$REPORT_FILE"
fi
echo ""

#############################################
# SUMMARY
#############################################
print_header "Comparison Summary"
echo ""

PASSED_CHECKS=$((TOTAL_CHECKS - FAILED_CHECKS))

echo "Total Checks: $TOTAL_CHECKS"
echo "Passed: $PASSED_CHECKS"
echo "Failed: $FAILED_CHECKS"
echo ""

cat >> "$REPORT_FILE" << EOF

---

## Summary

- **Total Checks:** $TOTAL_CHECKS
- **Passed:** $PASSED_CHECKS
- **Failed:** $FAILED_CHECKS

EOF

if [ $FAILED_CHECKS -eq 0 ]; then
    print_pass "All data comparison checks passed!"
    echo ""
    echo "✅ Models are functionally equivalent within ${THRESHOLD}% threshold."
    echo ""
    echo "**Verdict:** Safe to merge and deploy verified model."
    
    cat >> "$REPORT_FILE" << EOF

### ✅ Verdict: PASS

Models are functionally equivalent within ${THRESHOLD}% threshold.

**Recommendation:** Safe to merge and deploy verified model.

EOF
    
    print_info "Report saved: $REPORT_FILE"
    exit 0
else
    print_fail "$FAILED_CHECKS check(s) failed"
    echo ""
    echo "❌ Data differences exceed threshold."
    echo ""
    echo "**Next Steps:**"
    echo "  1. Review report: $REPORT_FILE"
    echo "  2. Investigate differences in data or logic"
    echo "  3. If differences are expected (timing, etc.), document in PR"
    echo "  4. Re-run comparison after fixes"
    
    cat >> "$REPORT_FILE" << EOF

### ❌ Verdict: FAIL

Data differences exceed threshold. Review required before merging.

**Next Steps:**
1. Investigate root cause of differences
2. Check for timing issues (e.g., new data created between builds)
3. Verify business logic matches between models
4. Document expected differences in PR description if applicable
5. Re-run comparison after fixes

EOF
    
    print_info "Report saved: $REPORT_FILE"
    exit 1
fi
